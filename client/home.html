<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Go links | Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.css"
    />
    <style></style>
  </head>
  <body class="p-4">
    <h1 class="is-size-1">Go links!</h1>
    <div x-data>
      <template x-if="!$store.auth.isAuth">
        <div class="is-flex is-flex-direction-column">
          <h2 class="is-size-4 mb-4">Login</h2>
          <input
            type="text"
            class="input mb-4"
            placeholder="username"
            x-model="$store.auth.username"
          />
          <input
            type="password"
            class="input mb-4"
            placeholder="password"
            x-model="$store.auth.password"
          />
          <button
            x-on:click="$store.auth.login()"
            class="button is-primary mb-4"
          >
            Login
          </button>
          <p x-text="$store.auth.statusText"></p>
        </div>
      </template>
      <template x-if="$store.auth.isAuth">
        <div class="is-flex is-flex-direction-column">
          <p x-text="`Welcome ${$store.auth.username}!`"></p>
          <h2 class="is-size-4">Links</h2>
          <p x-text="$store.auth.statusText"></p>
          <table class="table">
            <thead>
              <tr>
                <th>Short link</th>
                <th>Url</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <input
                    type="text"
                    class="input"
                    placeholder="short"
                    x-model="$store.auth.current.short"
                  />
                </td>
                <td>
                  <input
                    type="text"
                    class="input"
                    placeholder="url"
                    x-model="$store.auth.current.url"
                  />
                </td>
                <td>
                  <button
                    class="button is-primary is-small"
                    x-on:click="$store.auth.addLink()"
                  >
                    Add
                  </button>
                </td>
              </tr>
              <template x-for="link in $store.auth.links">
                <tr>
                  <td>
                    <a x-bind:href="'/'+link.short" x-text="link.short"></a>
                  </td>
                  <td><a x-bind:href="link.url" x-text="link.url"></a></td>
                  <td>
                    <button
                      class="button is-danger is-small"
                      x-on:click="$store.auth.deleteLink(link)"
                    >
                      Delete
                    </button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </template>
    </div>
    <script
      src="https://unpkg.com/alpinejs@3.10.5/dist/cdn.min.js"
      defer
    ></script>
    <script>
      document.addEventListener("alpine:init", () => {
        Alpine.store("auth", {
          username: "",
          password: "",
          isAuth: false,
          links: [],
          statusText: "",
          current: {
            short: "",
            url: "",
          },
          async login() {
            this.statusText = "";
            const resp = await fetch("/api/link", {
              headers: {
                Authorization: `Basic ${btoa(
                  this.username + ":" + this.password
                )}`,
              },
            });
            if (resp.status === 200) {
              this.isAuth = true;
              this.links = await resp.json();
            } else {
              this.isAuth = false;
              this.statusText = "Unable to login! Check credentials.";
            }
          },
          async addLink() {
            this.statusText = "";
            const resp = await fetch("/api/link", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Basic ${btoa(
                  this.username + ":" + this.password
                )}`,
              },
              body: JSON.stringify(this.current),
            });
            if (resp.status === 201) {
              this.statusText = "Added link successfully!";
              this.current.short = "";
              this.current.url = "";
              const resp = await fetch("/api/link", {
                headers: {
                  Authorization: `Basic ${btoa(
                    this.username + ":" + this.password
                  )}`,
                },
              });
              if (resp.status === 200) {
                this.links = await resp.json();
              } else {
                this.statusText = "Unable to fetch links!";
              }
            } else {
              this.statusText = await resp.text();
            }
          },
          async deleteLink(link) {
            this.statusText = "";
            const resp = await fetch("/api/link", {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Basic ${btoa(
                  this.username + ":" + this.password
                )}`,
              },
              body: JSON.stringify({
                short: link.short,
              }),
            });
            if (resp.status === 200) {
              this.statusText = "Deleted link successfully!";
              const resp = await fetch("/api/link", {
                headers: {
                  Authorization: `Basic ${btoa(
                    this.username + ":" + this.password
                  )}`,
                },
              });
              if (resp.status === 200) {
                this.links = await resp.json();
              } else {
                this.statusText = "Unable to fetch links!";
              }
            } else {
              this.statusText = await resp.text();
            }
          },
        });
      });
    </script>
  </body>
</html>
